import React, { useState, useMemo } from 'react';
import {
  XAxis, YAxis, CartesianGrid, Tooltip, Legend, 
  ResponsiveContainer, AreaChart, Area
} from 'recharts';

// --- UI Components ---
const Card = ({ children, className = "" }) => (
  <div className={`bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden ${className}`}>
    {children}
  </div>
);

const CardHeader = ({ title, subtitle }) => (
  <div className="px-6 py-5 border-b border-slate-100 bg-slate-50/50">
    <h3 className="text-lg font-bold text-slate-800">{title}</h3>
    {subtitle && <p className="text-sm text-slate-500 mt-1">{subtitle}</p>}
  </div>
);

const CardContent = ({ children, className = "" }) => (
  <div className={`p-6 ${className}`}>
    {children}
  </div>
);

// Styled Toggle Switch
const ToggleSwitch = ({ label, checked, onChange, helpText }) => (
  <div className="flex items-center justify-between p-4 bg-indigo-50 rounded-lg border border-indigo-100">
    <div>
      <label className="text-sm font-bold text-indigo-900 block">{label}</label>
      {helpText && <p className="text-xs text-indigo-600 mt-1">{helpText}</p>}
    </div>
    <button
      onClick={() => onChange(!checked)}
      className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 ${
        checked ? 'bg-indigo-600' : 'bg-slate-300'
      }`}
      type="button"
    >
      <span
        className={`${
          checked ? 'translate-x-6' : 'translate-x-1'
        } inline-block h-4 w-4 transform rounded-full bg-white transition-transform shadow-sm`}
      />
    </button>
  </div>
);

// Button Component
const Button = ({ onClick, children, variant = 'primary', className = '' }) => {
  const baseStyle = "px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 text-sm";
  const variants = {
    primary: "bg-indigo-600 text-white hover:bg-indigo-700 shadow-sm hover:shadow",
    secondary: "bg-white border border-slate-300 text-slate-700 hover:bg-slate-50",
    dashed: "border-2 border-dashed border-slate-300 text-slate-500 hover:border-indigo-500 hover:text-indigo-600 hover:bg-indigo-50",
    ghost: "text-slate-400 hover:text-red-500 hover:bg-red-50 p-1"
  };
  return (
    <button onClick={onClick} className={`${baseStyle} ${variants[variant]} ${className}`} type="button">
      {children}
    </button>
  );
};

export default function App() {
  // --- State ---
  const [activeView, setActiveView] = useState('dashboard');
  const [currentAge, setCurrentAge] = useState(0);
  const [years, setYears] = useState(65);
  const [inflationRate, setInflationRate] = useState(2);
  const [isCompound, setIsCompound] = useState(true); 
  
  const [items, setItems] = useState([
    { 
      id: 1, 
      name: '0050 ETF', 
      principal: 100000, 
      rate: 6, 
      contribution: 6000, 
      contributionFreq: 'monthly' 
    },
    { 
      id: 2, 
      name: 'ä¸­ä¿¡é‡‘', 
      principal: 50000, 
      rate: 8,
      contribution: 0,
      contributionFreq: 'monthly'
    },
  ]);

  // --- Helpers ---
  const formatCurrency = (val) => {
    if (isNaN(val)) return "$0";
    return new Intl.NumberFormat('zh-TW', {
      style: 'currency',
      currency: 'TWD',
      maximumFractionDigits: 0,
      minimumFractionDigits: 0
    }).format(val);
  };

  const handleNumberChange = (value, setter) => {
    if (value === '') setter('');
    else setter(Number(value));
  };

  const addItem = () => {
    if (items.length >= 10) return;
    const newId = items.length > 0 ? Math.max(...items.map(i => i.id)) + 1 : 1;
    setItems([...items, { 
      id: newId, 
      name: `æŠ•è³‡é …ç›® ${items.length + 1}`, 
      principal: 10000, 
      rate: 5,
      contribution: 3000,
      contributionFreq: 'monthly'
    }]);
  };

  const removeItem = (id) => {
    setItems(items.filter(item => item.id !== id));
  };

  const updateItem = (id, field, value) => {
    setItems(items.map(item => {
      if (item.id !== id) return item;
      if (['principal', 'rate', 'contribution'].includes(field)) {
        return { ...item, [field]: value === '' ? '' : Number(value) };
      }
      return { ...item, [field]: value };
    }));
  };

  // --- Calculation Logic ---
  const calculationResult = useMemo(() => {
    let yearlyData = [];
    const safeStartAge = currentAge === '' ? 0 : Number(currentAge);
    const safeYears = years === '' ? 0 : Number(years);
    
    // Initialize portfolios
    let currentPortfolios = items.map(item => ({
      ...item,
      currentValue: item.principal === '' ? 0 : parseFloat(item.principal),
      investedPrincipal: item.principal === '' ? 0 : parseFloat(item.principal),
      safeRate: item.rate === '' ? 0 : parseFloat(item.rate),
      safeContribution: item.contribution === '' ? 0 : parseFloat(item.contribution),
      accumulatedDividends: 0 
    }));

    let totalInvestedPrincipal = currentPortfolios.reduce((sum, item) => sum + item.investedPrincipal, 0);
    const loopYears = Math.min(Math.max(0, safeYears), 100); 

    for (let i = 0; i <= loopYears; i++) {
      let yearTotalNominal = 0;
      let yearTotalDividend = 0; 
      
      if (i === 0) {
        yearTotalNominal = totalInvestedPrincipal;
        yearTotalDividend = 0;
      } else {
        for (let m = 0; m < 12; m++) {
          currentPortfolios.forEach(item => {
            let contributionAmount = 0;
            if (item.contributionFreq === 'monthly') {
               contributionAmount = item.safeContribution;
            } else if (item.contributionFreq === 'yearly' && m === 0) {
               contributionAmount = item.safeContribution;
            }
            item.currentValue += contributionAmount;
            item.investedPrincipal += contributionAmount;

            const monthlyGrowth = item.currentValue * (item.safeRate / 100 / 12);
            
            if (isCompound) {
              item.currentValue += monthlyGrowth;
            } else {
              item.accumulatedDividends += monthlyGrowth;
            }
            yearTotalDividend += monthlyGrowth;
          });
        }
        
        if (isCompound) {
          yearTotalNominal = currentPortfolios.reduce((sum, item) => sum + item.currentValue, 0);
        } else {
          yearTotalNominal = currentPortfolios.reduce((sum, item) => sum + item.currentValue + item.accumulatedDividends, 0);
        }
        totalInvestedPrincipal = currentPortfolios.reduce((sum, item) => sum + item.investedPrincipal, 0);
      }

      const realValue = yearTotalNominal / Math.pow(1 + (inflationRate / 100), i);

      yearlyData.push({
        yearIndex: i,
        age: safeStartAge + i,
        principal: Math.round(totalInvestedPrincipal),
        nominalBalance: Math.round(yearTotalNominal),
        profit: Math.round(yearTotalNominal - totalInvestedPrincipal),
        dividend: Math.round(yearTotalDividend),
        realBalance: Math.round(realValue),
      });
    }
    return yearlyData;
  }, [currentAge, years, inflationRate, items, isCompound]);

  const finalResult = calculationResult.length > 0 
    ? calculationResult[calculationResult.length - 1] 
    : { principal: 0, nominalBalance: 0, profit: 0, realBalance: 0 };

  return (
    <div className="min-h-screen bg-slate-50 font-sans flex flex-col">
      
      {/* 1. Navbar */}
      <nav className="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div className="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between h-16">
            <div className="flex items-center gap-2">
              <span className="text-2xl">ğŸ“ˆ</span>
              <span className="font-bold text-xl text-slate-800 tracking-tight">è¤‡åˆ©è³‡ç”¢è¨ˆç®—æ©Ÿ</span>
            </div>
            <div className="flex items-center gap-4">
              <span className="text-sm text-slate-500 hidden sm:inline-block">æ‚¨çš„é•·æœŸæŠ•è³‡è¦åŠƒåŠ©æ‰‹</span>
              <div className="h-8 w-8 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 font-bold">
                A
              </div>
            </div>
          </div>
        </div>
      </nav>

      {/* 2. Main Content Area */}
      <main className="flex-grow container mx-auto px-4 py-8 max-w-6xl">
        
        {/* Intro Section */}
        <div className="mb-8 text-center sm:text-left">
          <h1 className="text-3xl font-extrabold text-slate-900 sm:text-4xl">æŠ•è³‡æœªä¾†ï¼Œå¾ç¾åœ¨é–‹å§‹</h1>
          <p className="mt-2 text-lg text-slate-600">
            é€éå®šæœŸå®šé¡èˆ‡è¤‡åˆ©æ•ˆæ‡‰ï¼Œæ¨¡æ“¬æ‚¨æœªä¾†çš„è³‡ç”¢å¢é•·æ›²ç·šã€‚æ”¯æ´å¤šç­†æŠ•è³‡é …ç›®èˆ‡é€šè†¨èª¿æ•´ã€‚
          </p>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
          
          {/* Left Sidebar: Controls */}
          <div className="lg:col-span-4 space-y-6">
            <Card>
              <CardHeader title="åŸºç¤è¨­å®š" />
              <CardContent className="space-y-6">
                <ToggleSwitch 
                  label="è¤‡åˆ©æ¨¡å¼ (é…æ¯å†æŠ•å…¥)" 
                  checked={isCompound} 
                  onChange={setIsCompound}
                  helpText={isCompound ? "ç›®å‰ï¼šç²åˆ©è‡ªå‹•æ»¾å…¥æœ¬é‡‘ç”Ÿæ¯" : "ç›®å‰ï¼šç²åˆ©é ˜å‡ºï¼Œä¸ç”¢ç”Ÿè¤‡åˆ©"}
                />
                
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1">ç›®å‰å¹´é½¡</label>
                    <input
                      type="number"
                      value={currentAge}
                      onChange={(e) => handleNumberChange(e.target.value, setCurrentAge)}
                      onFocus={(e) => e.target.select()}
                      className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-shadow"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1">æŠ•è³‡å¹´æ•¸</label>
                    <input
                      type="number"
                      value={years}
                      onChange={(e) => handleNumberChange(e.target.value, setYears)}
                      onFocus={(e) => e.target.select()}
                      className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-shadow"
                    />
                  </div>
                </div>

                <div>
                  <label className="flex justify-between text-sm font-medium text-slate-700 mb-2">
                    é æœŸå¹´é€šè†¨ç‡
                    <span className="bg-slate-100 px-2 py-0.5 rounded text-slate-600">{inflationRate}%</span>
                  </label>
                  <input 
                    type="range" 
                    min="0" 
                    max="10" 
                    step="0.5"
                    value={inflationRate} 
                    onChange={(e) => setInflationRate(Number(e.target.value))}
                    className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"
                  />
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardHeader 
                title={`æŠ•è³‡çµ„åˆç®¡ç† (${items.length}/10)`} 
                subtitle="è¨­å®šæœ¬é‡‘èˆ‡å®šæœŸå®šé¡" 
              />
              <CardContent className="space-y-4 max-h-[600px] overflow-y-auto custom-scrollbar">
                {items.map((item) => (
                  <div key={item.id} className="bg-white p-4 rounded-lg border border-slate-200 shadow-sm relative hover:border-indigo-300 transition-colors">
                    <div className="absolute top-3 right-3">
                      <Button variant="ghost" onClick={() => removeItem(item.id)}>ğŸ—‘ï¸</Button>
                    </div>
                    
                    <div className="space-y-4">
                      {/* Name */}
                      <div>
                        <label className="text-xs font-bold text-slate-500 uppercase tracking-wide">æ¨™çš„åç¨±</label>
                        <input
                          type="text"
                          value={item.name}
                          onChange={(e) => updateItem(item.id, 'name', e.target.value)}
                          className="w-full mt-1 px-2 py-1.5 text-sm border-b-2 border-slate-200 focus:border-indigo-500 outline-none bg-transparent transition-colors font-medium text-slate-900"
                          placeholder="ä¾‹å¦‚: 0050"
                        />
                      </div>

                      {/* Main Params */}
                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <label className="text-xs font-bold text-slate-500 uppercase tracking-wide">åˆå§‹æœ¬é‡‘</label>
                          <div className="relative mt-1">
                            <span className="absolute left-2 top-1.5 text-slate-400 text-sm">$</span>
                            <input
                              type="number"
                              value={item.principal}
                              onChange={(e) => updateItem(item.id, 'principal', e.target.value)}
                              className="w-full pl-6 pr-2 py-1.5 text-sm border border-slate-200 rounded focus:border-indigo-500 outline-none"
                            />
                          </div>
                        </div>
                        <div>
                          <label className="text-xs font-bold text-slate-500 uppercase tracking-wide">å¹´å ±é…¬ç‡</label>
                          <div className="relative mt-1">
                            <input
                              type="number"
                              step="0.1"
                              value={item.rate}
                              onChange={(e) => updateItem(item.id, 'rate', e.target.value)}
                              className="w-full pl-2 pr-6 py-1.5 text-sm border border-slate-200 rounded focus:border-indigo-500 outline-none"
                            />
                            <span className="absolute right-2 top-1.5 text-slate-400 text-sm">%</span>
                          </div>
                        </div>
                      </div>

                      {/* Regular Contribution */}
                      <div className="pt-3 border-t border-slate-100">
                        <label className="text-xs font-bold text-indigo-600 uppercase tracking-wide flex items-center gap-1 mb-2">
                          <span>âš™ï¸</span> å®šæœŸå®šé¡è¨­å®š
                        </label>
                        <div className="flex gap-2">
                          <input
                            type="number"
                            value={item.contribution}
                            onChange={(e) => updateItem(item.id, 'contribution', e.target.value)}
                            className="flex-1 px-3 py-1.5 text-sm border border-slate-200 rounded focus:border-indigo-500 outline-none"
                            placeholder="æŠ•å…¥é‡‘é¡"
                          />
                          <select 
                            value={item.contributionFreq}
                            onChange={(e) => updateItem(item.id, 'contributionFreq', e.target.value)}
                            className="w-24 px-2 py-1.5 text-sm border border-slate-200 rounded focus:border-indigo-500 outline-none bg-white"
                          >
                            <option value="monthly">æ¯æœˆ</option>
                            <option value="yearly">æ¯å¹´</option>
                          </select>
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
                
                {items.length < 10 && (
                  <Button variant="dashed" onClick={addItem} className="w-full py-3">
                    â• æ–°å¢æŠ•è³‡é …ç›®
                  </Button>
                )}
              </CardContent>
            </Card>
          </div>

          {/* Right Main Column: Charts & Data */}
          <div className="lg:col-span-8 space-y-8">
            
            {/* KPI Cards */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col justify-between h-32">
                <div className="text-slate-500 text-sm font-medium flex items-center gap-2">
                  <span>ğŸ’°</span> ç´¯ç©ç¸½æŠ•å…¥æˆæœ¬
                </div>
                <div>
                  <div className="text-2xl font-bold text-slate-900">{formatCurrency(finalResult.principal)}</div>
                  <div className="text-xs text-slate-400 mt-1">åˆå§‹æœ¬é‡‘ + æ‰€æœ‰å®šæœŸå®šé¡</div>
                </div>
              </div>
              <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col justify-between h-32">
                <div className="text-green-600 text-sm font-medium flex items-center gap-2">
                  <span>ğŸ“ˆ</span> æœŸæœ«åç›®ç¸½è³‡ç”¢
                </div>
                <div>
                  <div className="text-2xl font-bold text-green-600">{formatCurrency(finalResult.nominalBalance)}</div>
                  <div className="text-xs text-green-700/60 mt-1">
                    ç¸½ç²åˆ©: +{formatCurrency(finalResult.profit)}
                  </div>
                </div>
              </div>
              <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col justify-between h-32 bg-gradient-to-br from-indigo-50 to-white">
                <div className="text-purple-600 text-sm font-medium flex items-center gap-2">
                  <span>ğŸ›¡ï¸</span> å¯¦è³ªè³¼è²·åŠ›
                </div>
                <div>
                  <div className="text-2xl font-bold text-purple-600">{formatCurrency(finalResult.realBalance)}</div>
                  <div className="text-xs text-purple-700/60 mt-1">
                    ç¶“ {inflationRate}% é€šè†¨èª¿æ•´å¾Œåƒ¹å€¼
                  </div>
                </div>
              </div>
            </div>

            {/* View Toggle Tabs */}
            <div className="border-b border-slate-200">
              <nav className="-mb-px flex space-x-8">
                <button
                  onClick={() => setActiveView('dashboard')}
                  className={`
                    whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors
                    ${activeView === 'dashboard'
                      ? 'border-indigo-500 text-indigo-600'
                      : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'}
                  `}
                >
                  ğŸ“Š è³‡ç”¢æˆé•·åœ–è¡¨
                </button>
                <button
                  onClick={() => setActiveView('table')}
                  className={`
                    whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors
                    ${activeView === 'table'
                      ? 'border-indigo-500 text-indigo-600'
                      : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'}
                  `}
                >
                  ğŸ“‹ å¹´åº¦è©³ç´°å ±è¡¨
                </button>
              </nav>
            </div>

            {/* Content View */}
            <div className="bg-white rounded-xl border border-slate-200 shadow-sm min-h-[500px] p-6">
              {activeView === 'dashboard' ? (
                <div className="h-[450px] w-full">
                  <ResponsiveContainer width="100%" height="100%">
                    <AreaChart data={calculationResult} margin={{ top: 20, right: 30, left: 0, bottom: 0 }}>
                      <defs>
                        <linearGradient id="colorNominal" x1="0" y1="0" x2="0" y2="1">
                          <stop offset="5%" stopColor="#16a34a" stopOpacity={0.1}/>
                          <stop offset="95%" stopColor="#16a34a" stopOpacity={0}/>
                        </linearGradient>
                        <linearGradient id="colorReal" x1="0" y1="0" x2="0" y2="1">
                          <stop offset="5%" stopColor="#9333ea" stopOpacity={0.1}/>
                          <stop offset="95%" stopColor="#9333ea" stopOpacity={0}/>
                        </linearGradient>
                      </defs>
                      <XAxis 
                        dataKey="age" 
                        tick={{fill: '#64748b', fontSize: 12}}
                        tickLine={false}
                        axisLine={false}
                        label={{ value: 'å¹´é½¡', position: 'insideBottomRight', offset: -5, fill: '#64748b' }} 
                      />
                      <YAxis 
                        tickFormatter={(value) => `${(value / 10000).toFixed(0)}è¬`}
                        tick={{fill: '#64748b', fontSize: 12}}
                        tickLine={false}
                        axisLine={false}
                        width={80}
                      />
                      <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                      <Tooltip 
                        formatter={(value) => formatCurrency(value)}
                        contentStyle={{ backgroundColor: '#fff', borderRadius: '8px', border: '1px solid #e2e8f0', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }}
                      />
                      <Legend verticalAlign="top" height={36} iconType="circle"/>
                      <Area 
                        type="monotone" 
                        dataKey="nominalBalance" 
                        name="åç›®ç¸½è³‡ç”¢" 
                        stroke="#16a34a" 
                        fill="url(#colorNominal)" 
                        strokeWidth={2}
                      />
                      <Area 
                        type="monotone" 
                        dataKey="principal" 
                        name="ç´¯ç©æŠ•å…¥æœ¬é‡‘" 
                        stroke="#94a3b8" 
                        fill="#f8fafc"
                        fillOpacity={0.8}
                        strokeWidth={2}
                      />
                      <Area 
                        type="monotone" 
                        dataKey="realBalance" 
                        name="å¯¦è³ªè³¼è²·åŠ›" 
                        stroke="#9333ea" 
                        fill="url(#colorReal)" 
                        strokeWidth={2}
                        strokeDasharray="5 5"
                      />
                    </AreaChart>
                  </ResponsiveContainer>
                </div>
              ) : (
                <div className="overflow-x-auto">
                  <table className="w-full text-sm text-left border-collapse">
                    <thead className="text-xs text-slate-500 uppercase bg-slate-50">
                      <tr>
                        <th className="px-6 py-4 font-semibold border-b border-slate-200">å¹´é½¡</th>
                        <th className="px-6 py-4 font-semibold text-right border-b border-slate-200">ç´¯ç©æœ¬é‡‘</th>
                        <th className="px-6 py-4 font-semibold text-right text-green-600 border-b border-slate-200">ç•¶å¹´åº¦ç²åˆ©</th>
                        <th className="px-6 py-4 font-semibold text-right border-b border-slate-200">åç›®ç¸½è³‡ç”¢</th>
                        <th className="px-6 py-4 font-semibold text-right text-purple-600 border-b border-slate-200">å¯¦è³ªè³¼è²·åŠ›</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100">
                      {calculationResult.map((row) => (
                        <tr key={row.age} className="hover:bg-slate-50 transition-colors">
                          <td className="px-6 py-4 font-medium text-slate-900">{row.age} æ­²</td>
                          <td className="px-6 py-4 text-right font-mono text-slate-600">{formatCurrency(row.principal)}</td>
                          <td className="px-6 py-4 text-right font-mono text-green-600 bg-green-50/30 rounded-lg m-1">
                            {row.dividend > 0 ? `+${formatCurrency(row.dividend)}` : '-'}
                          </td>
                          <td className="px-6 py-4 text-right font-mono font-bold text-slate-800">{formatCurrency(row.nominalBalance)}</td>
                          <td className="px-6 py-4 text-right font-mono text-purple-600 font-medium">{formatCurrency(row.realBalance)}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          </div>
        </div>
      </main>

      {/* 3. Footer */}
      <footer className="bg-white border-t border-slate-200 mt-12 py-8">
        <div className="container mx-auto px-4 text-center text-slate-500 text-sm">
          <p>Â© 2024 è¤‡åˆ©è³‡ç”¢è¨ˆç®—æ©Ÿ. æ­¤å·¥å…·åƒ…ä¾›è©¦ç®—åƒè€ƒï¼Œä¸ä»£è¡¨å¯¦éš›æŠ•è³‡ç¸¾æ•ˆã€‚</p>
          <p className="mt-2">æŒçºŒå®šæœŸå®šé¡ï¼Œæ˜¯ç´¯ç©è²¡å¯Œçš„æœ€ä½³æ·å¾‘ã€‚</p>
        </div>
      </footer>

    </div>
  );
}
